# 0-1Learning

![alt text](../../static/common/svg/luoxiaosheng.svg "公众号")
![alt text](../../static/common/svg/luoxiaosheng_learning.svg "学习")
![alt text](../../static/common/svg/luoxiaosheng_wechat.svg "微信")
![alt text](../../static/common/svg/luoxiaosheng_gitee.svg "码云")


## 分组函数

本章要点

• 分组函数的目的

• 分组函数基本概念

• SUM、AVG、MIN、MAX、COUNT函数使用

• GROUP BY子句

• HAVING子句

### 分组函数
• 分组函数是对表中一组记录进行操作，每组只返回一个结果。 即首先要对表记录进行分组，然后再进行操作汇总，每组返回 一个结果。分组时可能是整个表分为一组，也可能根据条件分 成多组。

• 分组函数常用到以下的五个函数：
– MIN
– MAX
– SUM
– AVG
– COUNT

#### MIN函数和MAX函数

• MIN和MAX函数主要是返回每组的最小值和最大值。

– MIN([DISTINCT|ALL]表达式)

– MAX([DISTINCT|ALL]表达式)

• 例6-1 员工最低工资及最高工资的示例。

SELECT MIN(salary), MAX(salary) FROM employees;

• 例6-2 员工姓最开始及最后的示例。

SELECT MIN(last_name), MAX(last_name) FROM employees;

• 例6-3 员工最低工资及最高工资的示例 。

SELECT MIN(salary), MAX(salary) FROM employees;

#### SUM函数和AVG函数

• SUM和AVG函数分别返回总和及平均值。

– SUM([DISTINCT|ALL]n)

– AVG([DISTINCT|ALL]n)

• SUM和AVG函数都是只能够对数字类型的列或表达式操作。

• 例6-4 公司员工总工资及平均工资的示例。

SELECT FROM

SUM(salary), AVG(salary) employees;

#### COUNT函数

• COUNT函数的主要功能是返回每组记录的条数。 – COUNT({*|[DISTINCT|ALL]表达式})

• 例6-5 公司IT_PROG职位的员工人数的示例。

SELECT COUNT(*) FROM employees WHERE job_id='IT_PROG';

• 例6-6 公司有部门员工人数的示例。

SELECT COUNT(department_id) FROM employees;

#### 组函数中DISTINCT

• DISTINCT会消除重复记录后再使用组函数

• 例6-7 公司有员工部门数的示例。

SELECT COUNT(DISTINCT department_id) FROM employees;

### 组函数中空值处理

• 所有组函数对空值都是忽略的。

• 例6-8 员工平均奖金的示例——忽略空值。

SELECT FROM

AVG(commission_pct) employees;

• 例6-9 员工平均奖金的示例——空值转化。

SELECT FROM

AVG(NVL(commission_pct,0)) employees;

### 分组函数
GROUP BY子句 

SELECT FROM [WHERE [GROUP BY [ORDER BY

列名, 组函数(列名) 表名 条件] 分组列] 列名];

• 组函数忽略空值,可以使用NVL,NVL2,COALESCE 函数处 理空值

• 结果集隐式按升序排列,如果需要改变排序方式可以使用 Order by 子句(9i)

• 例6-10 每个部门的总工资。

SELECT department_id, SUM(salary) FROM employees GROUP BY department_id ;

• 例6-11 相同职位且经理相同的员工平均工资。

SELECT job_id,manager_id, AVG(salary) FROM employees GROUP BY job_id,manager_id ORDER BY job_id;

• 在GROUP BY子句使用中，有两点需要注意：

– GROUP BY子句后的列可以不在SELECT语句中出现。

– SELECT子句中出现的非分组函数列必须在GROUP BY子句 中出现。

• 例6-12 查询公司每个职位的平均工资，职位列不显示，同时结 果按照平均工资排序。

SELECT AVG(salary) FROM employees GROUP BY job_id ORDER BY AVG(salary);

• 例6-13 分组汇总错误示例

SELECT department_id, job_id, AVG(salary) FROM employees GROUP BY department_id;

• 例6-14 分组汇总正确示例

SELECT department_id, job_id, AVG(salary) FROM employees GROUP BY department_id,job_id;

### HAVING子句

• 例6-15 组函数筛选示例。

SELECT job_id, MAX(salary) FROM employees WHERE MAX(salary)>=9000 GROUP BY job_id;

• 原因是Oracle查询语句的执行顺序是： – FROM WHERE GROUP BY SELECT ORDER BY

• 语法结构如下：

SELECT FROM [WHERE [GROUP BY [HAVING [ORDER BY

列名, 组函数 表名 条件] 分组列] 组函数表达式] 列名];

• 例6-16 组函数筛选示例。
SELECT job_id, MAX(salary)    
FROM employees 
GROUP BY job_id HAVING MAX(salary)>=9000;

• 总结SELECT语句执行过程：

– 通过FROM子句中找到需要查询的表；

– 通过WHERE子句进行非分组函数筛选判断；

– 通过GROUP BY子句完成分组操作；

– 通过HAVING子句完成组函数筛选判断；

– 通过SELECT子句选择显示的列或表达式及组函数；

– 通过ORDER BY子句进行排序操作。


• 例6-17 组函数演示。

SELECT department_id, MAX(salary) 
FROM employees 
WHERE department_id BETWEEN 30 AND 90 
GROUP BY department_id 
HAVING MAX(salary)>=9000 
ORDER BY MAX(salary);

### 组函数的嵌套

• 组函数可以实现嵌套操作，嵌套级数是2级(select)。

• 例6-18 组函数嵌套演示。

SELECT MAX(COUNT(employee_id)) FROM employees GROUP BY department_id;










